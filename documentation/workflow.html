<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simple Extraction Workflow</title>
  <style>
    :root {
      --bg:#f8fafc; --panel:#ffffff; --border:#e2e8f0; --text:#0f172a;
      --accent:#2563eb; --accent-bg:#eff6ff; --muted:#64748b; --good:#059669; --warn:#dc2626;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, Arial, sans-serif; background:var(--bg); color:var(--text); line-height:1.35; }
    header { padding:1.8rem 1.6rem 1rem; }
    h1 { margin:0 0 .5rem; font-size:1.9rem; }
    p.lead { margin:.2rem 0 1.2rem; font-size:1.05rem; color:var(--muted); }
    main { max-width:1200px; margin:0 auto; padding:0 1.4rem 2.5rem; }
    .grid { display:grid; gap:1.2rem; }
    @media (min-width:900px){ .grid { grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); } }
    .step { position:relative; background:var(--panel); border:1px solid var(--border); border-radius:18px; padding:1rem .95rem 1.1rem; box-shadow:0 4px 8px -4px rgba(15,23,42,0.06); display:flex; flex-direction:column; gap:.65rem; }
    .step-number { position:absolute; top:-10px; left:-10px; background:var(--accent); color:#fff; width:38px; height:38px; border-radius:12px; font-weight:600; display:flex; align-items:center; justify-content:center; font-size:1rem; box-shadow:0 2px 4px rgba(0,0,0,0.15); }
    .step h2 { font-size:1.05rem; margin:0; padding-left:1.8rem; line-height:1.2; }
    ul.inline { list-style:none; margin:0; padding:0; display:flex; flex-wrap:wrap; gap:.4rem; }
    .badge { font-size:.68rem; font-weight:600; letter-spacing:.5px; text-transform:uppercase; padding:.35rem .55rem; border-radius:6px; background:var(--accent-bg); color:var(--accent); border:1px solid #bfdbfe; }
    .badge.out { background:#ecfdf5; border-color:#bbf7d0; color:var(--good); }
    .badge.in { background:#f0f9ff; border-color:#bae6fd; color:#0369a1; }
    .badge.mid { background:#fff7ed; border-color:#fed7aa; color:#c2410c; }
    .files { font-size:.72rem; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; background:#f1f5f9; padding:.55rem .6rem; border-radius:8px; border:1px solid var(--border); line-height:1.25; white-space:pre-line; }
    .arrow-flow { margin:1.4rem auto; max-width:880px; display:flex; flex-wrap:wrap; gap:.6rem; justify-content:center; font-size:.75rem; }
    .arrow-flow span { background:#1e293b; color:#fff; padding:.5rem .8rem; border-radius:999px; font-weight:500; letter-spacing:.5px; position:relative; }
    .arrow-flow span:after { content:""; position:absolute; right:-14px; top:50%; transform:translateY(-50%); border:7px solid transparent; border-left-color:#1e293b; }
    .arrow-flow span:last-child:after { display:none; }
    .legend { display:flex; flex-wrap:wrap; gap:.6rem; margin-top:.3rem; }
    .legend-item { display:flex; align-items:center; gap:.35rem; font-size:.7rem; background:#fff; border:1px solid var(--border); padding:.35rem .55rem; border-radius:8px; }
    .dot { width:12px; height:12px; border-radius:4px; }
    .dot.in { background:#f0f9ff; border:1px solid #7dd3fc; }
    .dot.proc { background:#eef2ff; border:1px solid #c7d2fe; }
    .dot.out { background:#ecfdf5; border:1px solid #bbf7d0; }
    .dot.mid { background:#fff7ed; border:1px solid #fed7aa; }
    .dot.loop { background:#f5f3ff; border:1px solid #e9d5ff; }
    .connect { margin:2.2rem 0 1.5rem; font-size:.8rem; text-align:center; color:var(--muted); }
    .schema { display:grid; gap:1rem; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); margin-top:1rem; }
    details { background:var(--panel); border:1px solid var(--border); padding:.9rem 1rem; border-radius:14px; }
    details summary { cursor:pointer; font-weight:600; }
    code.inline { background:#e2e8f0; padding:2px 6px; border-radius:4px; font-size:.8rem; }
    footer { margin-top:3rem; padding:1.2rem 0 2rem; font-size:.65rem; text-align:center; color:var(--muted); }
  </style>
</head>
<body>
  <header>
    <h1>Simple Extraction Workflow</h1>
    <p class="lead">From PDF permit ➜ raw text ➜ structured JSON ➜ metrics & Excel ➜ iterative improvement.</p>
    <div class="legend">
      <div class="legend-item"><div class="dot in"></div> Input</div>
      <div class="legend-item"><div class="dot proc"></div> Process</div>
      <div class="legend-item"><div class="dot mid"></div> Intermediate Store</div>
      <div class="legend-item"><div class="dot out"></div> Output</div>
      <div class="legend-item"><div class="dot loop"></div> Improvement Loop</div>
    </div>
  </header>
  <main>
    <!-- Static SVG overview (always visible even if CSS/JS blocked) -->
    <section style="margin:0 0 1.8rem;">
      <h2 style="margin:.2rem 0 .6rem;font-size:1.1rem;">High-Level Flow (Static SVG)</h2>
      <div style="background:#fff;border:1px solid var(--border);border-radius:14px;padding:1rem;overflow:auto;">
        <svg xmlns="http://www.w3.org/2000/svg" width="980" height="140" role="img" aria-label="PDF to Reports pipeline" style="max-width:100%;height:auto;font-family:system-ui,Arial,sans-serif;">
          <defs>
            <style>
              .blk{fill:#ffffff;stroke:#2563eb;stroke-width:1.5;rx:12;ry:12;}
              .txt{font-size:13px;fill:#0f172a;font-weight:600;}
              .sub{font-size:11px;fill:#475569;font-weight:400;}
              .arrow{stroke:#1e293b;stroke-width:1.4;marker-end:url(#mArrow);} 
            </style>
            <marker id="mArrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
              <path d="M0,0 L0,6 L9,3 z" fill="#1e293b" />
            </marker>
          </defs>
          <!-- Blocks -->
          <g transform="translate(10,20)">
            <rect class="blk" width="130" height="90"/>
            <text x="65" y="42" text-anchor="middle" class="txt">PDFs</text>
            <text x="65" y="60" text-anchor="middle" class="sub">data/**</text>
          </g>
          <g transform="translate(170,20)">
            <rect class="blk" width="170" height="90"/>
            <text x="85" y="38" text-anchor="middle" class="txt">Extraction</text>
            <text x="85" y="56" text-anchor="middle" class="sub">compare_pdf_extractors</text>
          </g>
          <g transform="translate(370,20)">
            <rect class="blk" width="170" height="90"/>
            <text x="85" y="32" text-anchor="middle" class="txt">Structured JSON</text>
            <text x="85" y="50" text-anchor="middle" class="sub">build_structured_json</text>
          </g>
            <g transform="translate(570,20)">
            <rect class="blk" width="150" height="90"/>
            <text x="75" y="38" text-anchor="middle" class="txt">Benchmark</text>
            <text x="75" y="56" text-anchor="middle" class="sub">benchmark_evaluation</text>
          </g>
          <g transform="translate(750,20)">
            <rect class="blk" width="210" height="90"/>
            <text x="105" y="32" text-anchor="middle" class="txt">Excel & Report</text>
            <text x="105" y="50" text-anchor="middle" class="sub">build_excel_comparison</text>
          </g>
          <!-- Arrows -->
          <line class="arrow" x1="140" y1="65" x2="170" y2="65"/>
          <line class="arrow" x1="340" y1="65" x2="370" y2="65"/>
          <line class="arrow" x1="540" y1="65" x2="570" y2="65"/>
          <line class="arrow" x1="720" y1="65" x2="750" y2="65"/>
        </svg>
        <pre style="margin:1rem 0 0;font-size:.7rem;color:#475569;">PDFs -> Extraction -> Structured JSON -> Benchmark -> Excel & Report</pre>
      </div>
    </section>
    <div class="arrow-flow">
      <span>PDFs</span>
      <span>Extraction</span>
      <span>Structured JSON</span>
      <span>Benchmark</span>
      <span>Excel & Report</span>
      <span>Refine</span>
    </div>

    <section class="grid" aria-label="Workflow Steps">
      <div class="step" id="step1">
        <div class="step-number">1</div>
        <h2>Raw Text Extraction</h2>
        <ul class="inline">
          <li class="badge in">Input</li>
          <li class="badge">Process</li>
          <li class="badge out">Output</li>
        </ul>
        <p>Run <code class="inline">compare_pdf_extractors.py</code> across all PDFs (recursive). Generates paired raw text for two engines plus basic stats.</p>
        <div class="files">Outputs:
*_pdfplumber.txt
*_docling.txt (optional)
*_compare.json
_aggregate_summary.json</div>
      </div>
      <div class="step" id="step2">
        <div class="step-number">2</div>
        <h2>Parsing to Structured JSON</h2>
        <ul class="inline">
          <li class="badge mid">Intermediate</li>
          <li class="badge">Process</li>
        </ul>
        <p><code class="inline">build_structured_json.py</code> converts raw text → normalized schema (KAEK, Owners, Coverage 4×7). Heuristics fix fragmented codes & EU numbers.</p>
        <div class="files">structured_json/
<stem>_pdfplumber_structured.json
<stem>_docling_structured.json</div>
      </div>
      <div class="step" id="step3">
        <div class="step-number">3</div>
        <h2>Benchmark Evaluation</h2>
        <ul class="inline"><li class="badge">Process</li><li class="badge out">Output</li></ul>
        <p><code class="inline">benchmark_evaluation.py</code> compares structured values vs ground-truth CSV computing KAEK match, owner precision / recall / F1, coverage exact ratio, MAE & RMSE.</p>
        <div class="files">benchmark_report.json</div>
      </div>
      <div class="step" id="step4">
        <div class="step-number">4</div>
        <h2>Excel Comparison</h2>
        <ul class="inline"><li class="badge">Process</li><li class="badge out">Output</li></ul>
        <p><code class="inline">build_excel_comparison.py</code> creates review workbook with sheets for KAEK, Owners, Coverage (wide & mismatches).</p>
        <div class="files">benchmark_side_by_side.xlsx</div>
      </div>
      <div class="step" id="step5">
        <div class="step-number">5</div>
        <h2>Iterative Refinement</h2>
        <ul class="inline"><li class="badge">Process</li><li class="badge loop">Loop</li></ul>
        <p>Review mismatches → adjust heuristics (<code class="inline">parse_eu_number</code>, KAEK suffix, owner parsing) → add / run tests → regenerate.</p>
        <div class="files">tests/test_parsing.py<br/>EXTRACTION_LOGIC.md</div>
      </div>
    </section>

    <div class="connect">All steps can be re-run independently; only regenerate downstream artifacts after changing a stage.</div>

    <details>
      <summary>JSON Schema (Simplified)</summary>
      <div class="files">{
  "ΑΔΑ": "...",
  "ΚΑΕΚ": "50097350003/0/0",
  "Στοιχεία κυρίου του έργου": [ { "Επώνυμο/ία": "...", "Όνομα": "...", "Ποσοστό": 50.0 } ],
  "Στοιχεία Διαγράμματος Κάλυψης": {
    "ΥΦΙΣΤΑΜΕΝΑ": { "Εμβ. κάλυψης κτιρίου": 123.45, ... },
    "ΝΟΜΙΜΟΠΟΙΟΥΜΕΝΑ": { ... },
    "ΠΡΑΓΜΑΤΟΠΟΙΟΥΜΕΝΑ": { ... },
    "ΣΥΝΟΛΟ": { ... }
  }
}</div>
    </details>

    <details>
      <summary>Run Sequence (CLI)</summary>
      <div class="files">python compare_pdf_extractors.py --root data --output-dir debug/compare --save-text --sample-lines 0
python build_structured_json.py --all --compare-dir debug/compare --out-dir debug/structured_json
python benchmark_evaluation.py --benchmark-csv data/01_benchmark/eadeies_final.csv --structured-dir debug/structured_json --out debug/benchmark_report.json
python build_excel_comparison.py --benchmark-csv data/01_benchmark/eadeies_final.csv --structured-dir debug/structured_json --out debug/benchmark_side_by_side.xlsx</div>
    </details>
  </main>
  <footer>Simplified workflow view · Adjust visuals in documentation/workflow.html</footer>
</body>
</html>
